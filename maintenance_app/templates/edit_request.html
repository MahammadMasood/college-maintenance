{% extends 'base.html' %}
{% load static %}
{% block title %}Edit Request{% endblock %}
{% block content %}
<div class="container mt-4">
  <div class="card">
    <div class="card-header">
      <h4><strong>Edit Request</strong> — {{ req.title }}</h4>
    </div>

    <div class="card-body">
      <form method="post" id="editRequestForm">
        {% csrf_token %}

        <div class="row mb-3">
          <div class="col-md-4">
            <label class="form-label">Branch</label>
            <input type="text" name="branch" class="form-control" value="{{ req.branch }}">
          </div>
          <div class="col-md-4">
            <label class="form-label">Title</label>
            <input type="text" name="title" class="form-control" value="{{ req.title }}">
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Description</label>
          <textarea name="description" class="form-control" rows="3">{{ req.description }}</textarea>
        </div>

        <hr>
        <h5>Equipment List</h5>

        <div class="table-responsive">
          <table class="table table-bordered text-center align-middle" id="equipmentTable">
            <thead class="table-light">
              <tr>
                <th>Select</th>
                <th>Device</th>
                <th>Brand/Model</th>
                <th>Size</th>
                <th>Price (₹)</th>
                <th>Usage</th>
                <th>Remarks</th>
                <th>Quantity</th>
                <th>Subtotal (₹)</th>
              </tr>
            </thead>
            <tbody>
              {% for item in items %}
              {% with key=item.device|add:'_'|add:item.size %}
              <tr>
                <td>
                  <input type="checkbox"
                         class="item-checkbox"
                         data-price="{{ item.price }}"
                         {% if selected_data.key %}checked{% endif %}>
                </td>
                <td class="device">{{ item.device }}</td>
                <td class="brand">{{ item.brand }}</td>
                <td class="size">{{ item.size }}</td>
                <td class="price">{{ item.price }}</td>
                <td class="usage">{{ item.usage }}</td>
                <td class="remarks">{{ item.remarks }}</td>
                <td>
                  <input type="number"
                         class="form-control qty-input"
                         min="0"
                         style="width:100px;"
                         value="{{ selected_data.key|default:0 }}">
                </td>
                <td class="subtotal">0</td>
              </tr>
              {% endwith %}
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="text-end mt-2">
          <strong>Grand Total: ₹<span id="grandTotal">0</span></strong>
        </div>

        <!-- Hidden inputs -->
        <input type="hidden" name="selected_items" id="selectedItems">
        <input type="hidden" name="total_amount" id="totalAmount">

        <div class="mt-3 text-end">
          <a href="{% url 'admin_dashboard' %}" class="btn btn-secondary me-2">Cancel</a>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Pass existing selected_items JSON to JS safely
  {% if req.selected_items %}
    const existingItems = JSON.parse('{{ req.selected_items|escapejs }}');
  {% else %}
    const existingItems = [];
  {% endif %}
</script>

<script src="{% static 'js/script.js' %}"></script>
{%endblock%}